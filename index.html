<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ã‚¹ãƒ©ã‚¤ãƒ ã‚¯ãƒªãƒƒã‚«ãƒ¼ RPG</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=M+PLUS+Rounded+1c:wght@400;700;900&display=swap');

        body {
            font-family: 'M PLUS Rounded 1c', sans-serif;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
            background-color: #0f172a;
            color: #f1f5f9;
        }

        /* å…±é€šã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ */
        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-5px); }
        }
        @keyframes pulse-glow {
            0%, 100% { box-shadow: 0 0 5px #3b82f6; }
            50% { box-shadow: 0 0 20px #60a5fa; }
        }
        .anim-click { animation: click-squish 0.1s ease-out; }
        @keyframes click-squish {
            0% { transform: scale(1); }
            50% { transform: scale(0.9); }
            100% { transform: scale(1); }
        }
        .damage-text {
            position: absolute;
            pointer-events: none;
            animation: float-up 0.8s forwards;
            font-weight: 900;
            text-shadow: 0 0 3px black;
            z-index: 50;
        }
        @keyframes float-up {
            0% { transform: translateY(0) scale(1); opacity: 1; }
            100% { transform: translateY(-40px) scale(1.2); opacity: 0; }
        }

        /* ãƒ¡ã‚¤ãƒ³ã‚¹ãƒ©ã‚¤ãƒ  */
        .giant-slime {
            width: 180px; height: 160px;
            background: radial-gradient(circle at 30% 30%, #60a5fa, #2563eb);
            border-radius: 50% 50% 45% 45%;
            position: relative;
            box-shadow: inset 10px 10px 20px rgba(255,255,255,0.4), 0 10px 20px rgba(37,99,235,0.4);
            transition: transform 0.1s;
            cursor: pointer;
            margin: 0 auto;
        }
        .giant-slime::after {
            content: ''; position: absolute; top: 15%; left: 20%; width: 25%; height: 15%;
            background: rgba(255,255,255,0.7); border-radius: 50%; transform: rotate(-45deg);
        }

        /* æ•µã‚­ãƒ£ãƒ© */
        .enemy-sprite {
            width: 120px; height: 120px;
            background-size: contain;
            background-repeat: no-repeat;
            background-position: center;
            position: relative;
            transition: filter 0.1s;
        }
        .shake { animation: shake 0.3s cubic-bezier(.36,.07,.19,.97) both; }
        @keyframes shake {
            10%, 90% { transform: translate3d(-1px, 0, 0); }
            20%, 80% { transform: translate3d(2px, 0, 0); }
            30%, 50%, 70% { transform: translate3d(-4px, 0, 0); }
            40%, 60% { transform: translate3d(4px, 0, 0); }
        }

        /* ã‚¬ãƒãƒ£æ¼”å‡º */
        .card-shine {
            background: linear-gradient(135deg, rgba(255,255,255,0) 0%, rgba(255,255,255,0.2) 50%, rgba(255,255,255,0) 100%);
            background-size: 200% 200%;
            animation: shine 3s infinite;
        }
        @keyframes shine { 0% { background-position: 200% 0; } 100% { background-position: -200% 0; } }

        /* è³¼å…¥å¯èƒ½æ™‚ã®å¼·èª¿ */
        .can-buy {
            border-color: #60a5fa !important;
            box-shadow: 0 0 10px rgba(59, 130, 246, 0.3);
            background-color: #1e293b !important; /* bg-slate-800 */
        }
        .can-buy:hover {
            background-color: #334155 !important; /* bg-slate-700 */
        }

        /* é€šçŸ¥ãƒãƒƒã‚¸ */
        .nav-badge {
            position: absolute;
            top: 4px;
            right: 25%;
            width: 10px;
            height: 10px;
            background-color: #ef4444;
            border-radius: 50%;
            border: 2px solid #1e293b;
            display: none; /* JSã§åˆ¶å¾¡ */
        }
        .nav-badge.active {
            display: block;
            animation: bounce 1s infinite;
        }

        /* ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ãƒãƒ¼ */
        ::-webkit-scrollbar { width: 4px; }
        ::-webkit-scrollbar-track { background: #1e293b; }
        ::-webkit-scrollbar-thumb { background: #475569; border-radius: 2px; }
        
        /* ãƒ­ãƒƒã‚¯çŠ¶æ…‹ */
        .locked-btn {
            background-color: #334155;
            color: #94a3b8;
            cursor: not-allowed;
            opacity: 0.7;
        }
    </style>
</head>
<body class="h-screen w-screen overflow-hidden flex flex-col">

    <!-- ãƒ˜ãƒƒãƒ€ãƒ¼: ãƒªã‚½ãƒ¼ã‚¹è¡¨ç¤º -->
    <header class="bg-slate-800 border-b border-slate-700 p-2 flex justify-between items-center shadow-md z-20 shrink-0 h-16">
        <div class="flex flex-col">
            <div class="text-xs text-slate-400 font-bold">Slimes (é€šè²¨)</div>
            <div id="res-slimes" class="text-2xl font-black text-blue-400 tabular-nums">0</div>
        </div>
        <div class="flex flex-col items-center">
            <div class="text-xs text-slate-400 font-bold">SpS (ç§’é–“ç”Ÿç”£)</div>
            <div id="res-sps" class="text-lg font-bold text-slate-200 tabular-nums">0.0/s</div>
        </div>
        <div class="flex flex-col items-end">
            <div class="text-xs text-slate-400 font-bold">Gems (é­”çŸ³)</div>
            <div id="res-gems" class="text-2xl font-black text-purple-400 tabular-nums">0</div>
        </div>
    </header>

    <!-- ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚¨ãƒªã‚¢ (ã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆ) -->
    <main class="flex-1 relative overflow-hidden bg-slate-900">
        
        <!-- ã‚¨ãƒ•ã‚§ã‚¯ãƒˆãƒ¬ã‚¤ãƒ¤ãƒ¼ -->
        <div id="effect-layer" class="absolute inset-0 pointer-events-none z-50 overflow-hidden"></div>

        <!-- TAB 1: ãƒ¡ã‚¤ãƒ³ (ç”Ÿç”£) -->
        <div id="tab-main" class="tab-content absolute inset-0 flex flex-col items-center justify-center p-4 overflow-y-auto">
            
            <!-- ãƒãƒ•è¡¨ç¤º -->
            <div id="buff-container" class="absolute top-2 w-full flex justify-center gap-2 pointer-events-none"></div>

            <div class="relative group">
                <div id="main-slime" class="giant-slime hover:scale-105 active:scale-95 flex items-center justify-center">
                    <div class="absolute top-[35%] left-[25%] w-[10%] h-[10%] bg-slate-900 rounded-full opacity-70"></div>
                    <div class="absolute top-[35%] right-[25%] w-[10%] h-[10%] bg-slate-900 rounded-full opacity-70"></div>
                    <div class="absolute top-[60%] left-[45%] w-[10%] h-[5%] bg-slate-900 rounded-full opacity-50"></div>
                </div>
                <div class="text-center mt-6 text-slate-400 text-sm animate-pulse">TAP TO FARM</div>
            </div>

            <div class="mt-8 w-full max-w-md bg-slate-800/50 rounded p-4 border border-slate-700">
                <h3 class="text-xs font-bold text-slate-500 mb-2 text-center">STATS</h3>
                <div class="flex justify-between text-sm border-b border-slate-700 pb-1 mb-1">
                    <span>è»¢ç”Ÿå€ç‡:</span> <span id="stat-rebirth" class="font-bold text-yellow-400">x1.0</span>
                </div>
                <div class="flex justify-between text-sm">
                    <span>ã‚¯ãƒªãƒƒã‚¯åŠ›:</span> <span id="stat-click" class="font-bold text-green-400">1</span>
                </div>
            </div>
        </div>

        <!-- TAB 2: ãƒãƒˆãƒ« (æˆ¦é—˜ & æ­¦å™¨) -->
        <div id="tab-battle" class="tab-content absolute inset-0 hidden flex-col overflow-hidden">
            <!-- ä¸ŠåŠåˆ†: æˆ¦é—˜ç”»é¢ (å›ºå®š) -->
            <div class="h-1/2 flex flex-col items-center justify-center p-4 bg-slate-900 border-b border-slate-700 shrink-0 relative">
                <!-- ã‚¹ãƒ†ãƒ¼ã‚¸æƒ…å ± -->
                <div class="text-center mb-2 absolute top-2">
                    <div class="text-yellow-500 font-bold tracking-widest text-sm">STAGE <span id="battle-stage">1</span></div>
                </div>

                <!-- æ•µç”»åƒ -->
                <div id="enemy-container" class="relative cursor-crosshair active:scale-95 transition-transform mt-4">
                    <div id="enemy-visual" class="w-32 h-32 bg-slate-800 rounded-xl flex items-center justify-center text-6xl shadow-2xl border-2 border-red-900/50">
                        ğŸ‘¾
                    </div>
                    <!-- ã‚¯ãƒªãƒƒã‚¯æŒ‡ç¤ºã‚¢ãƒ‹ãƒ¡ -->
                    <div class="absolute -bottom-8 left-1/2 transform -translate-x-1/2 text-xs font-bold text-red-400 animate-bounce pointer-events-none whitespace-nowrap">
                        TAP TO ATTACK!
                    </div>
                </div>

                <!-- HPãƒãƒ¼ -->
                <div class="w-64 bg-slate-700 h-4 rounded-full overflow-hidden border border-slate-600 mt-6 relative">
                    <div id="enemy-hp-bar" class="h-full bg-gradient-to-r from-red-600 to-red-400 transition-all duration-200" style="width: 100%"></div>
                    <div class="absolute inset-0 flex items-center justify-center text-[10px] font-bold shadow-black drop-shadow-md">
                        HP: <span id="enemy-hp-text">100/100</span>
                    </div>
                </div>

                <div class="mt-2 text-center space-y-1">
                    <div class="text-xs font-bold text-slate-300">Total Attack: <span id="battle-dps" class="text-red-400">0</span></div>
                </div>
                
                <!-- ã‚ªãƒ¼ãƒˆé€²è¡Œãƒˆã‚°ãƒ« -->
                <div class="absolute bottom-2 right-4">
                    <label class="flex items-center gap-2 cursor-pointer">
                        <input type="checkbox" id="auto-battle-check" class="w-3 h-3 rounded bg-slate-700 border-slate-600 text-blue-600 focus:ring-blue-600 ring-offset-gray-800 focus:ring-2">
                        <span class="text-xs text-slate-400 select-none">Auto Next</span>
                    </label>
                </div>
            </div>

            <!-- ä¸‹åŠåˆ†: æ­¦å™¨å¼·åŒ– (ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«) -->
            <div class="h-1/2 flex flex-col bg-slate-800">
                <div class="p-2 bg-slate-800 border-b border-slate-700 text-xs font-bold text-slate-400 uppercase tracking-wider flex justify-between items-center">
                    <span>âš”ï¸ Weapons (é­”çŸ³ã§å¼·åŒ–)</span>
                    <span class="text-[10px] text-slate-500">æ”»æ’ƒåŠ›UP</span>
                </div>
                <div id="weapon-list" class="flex-1 overflow-y-auto p-2 space-y-2 custom-scrollbar">
                    <!-- JSã§ç”Ÿæˆ -->
                </div>
            </div>
        </div>

        <!-- TAB 3: ã‚¬ãƒãƒ£ & ãƒ¦ãƒ‹ãƒƒãƒˆ -->
        <div id="tab-gacha" class="tab-content absolute inset-0 hidden flex-col overflow-hidden bg-slate-900">
            <div class="p-4 bg-slate-800 border-b border-slate-700 flex justify-between items-center shrink-0">
                <h2 class="font-bold text-purple-400">ä»²é–“å¬å–š (Summon)</h2>
                <div class="text-xs text-slate-400">é€šè²¨ã‚’æ¶ˆè²»ã—ã¦ä»²é–“ã‚’ç²å¾—</div>
            </div>

            <div class="flex-1 overflow-y-auto p-4 custom-scrollbar">
                <!-- ã‚¬ãƒãƒ£ãƒœã‚¿ãƒ³ã‚¨ãƒªã‚¢ -->
                <div class="bg-gradient-to-br from-slate-800 to-slate-900 p-6 rounded-xl border border-slate-700 text-center mb-8 shadow-lg">
                    <div class="mb-4 text-4xl">ğŸ”®</div>
                    <h3 class="text-xl font-bold text-white mb-2">ã‚¹ãƒ©ã‚¤ãƒ å¬å–š</h3>
                    <p class="text-xs text-slate-400 mb-4">N:60% R:30% SR:9% SSR:1%</p>
                    
                    <button onclick="pullGacha(1)" id="btn-gacha-1" class="w-full py-3 bg-slate-700 text-slate-400 font-bold rounded shadow-lg transition-all mb-2 border border-slate-600">
                        <span id="gacha-btn-text">ãƒ­ãƒ¼ãƒ‰ä¸­...</span>
                    </button>
                    <div class="text-[10px] text-slate-500 mt-2">â€»æ—¢ã«æŒã£ã¦ã„ã‚‹ã‚­ãƒ£ãƒ©ã¯é­”çŸ³(Gem)ã«å¤‰æ›ã•ã‚Œã¾ã™</div>
                </div>

                <!-- æ‰€æŒãƒ¦ãƒ‹ãƒƒãƒˆãƒªã‚¹ãƒˆ -->
                <h3 class="font-bold text-slate-300 mb-2 flex items-center gap-2">
                    <span>Party Members</span>
                    <span class="text-xs font-normal bg-slate-700 px-2 py-1 rounded text-slate-400">é­”çŸ³ã§LvUP</span>
                </h3>
                <div id="unit-list" class="grid grid-cols-1 gap-2 pb-20">
                    <!-- JSã§ç”Ÿæˆ -->
                    <div class="text-center text-slate-500 py-4">ã¾ã ä»²é–“ãŒã„ã¾ã›ã‚“</div>
                </div>
            </div>
        </div>

        <!-- TAB 4: ã‚·ãƒ§ãƒƒãƒ— -->
        <div id="tab-shop" class="tab-content absolute inset-0 hidden flex-col bg-slate-900">
            <div class="flex-1 overflow-y-auto p-4 custom-scrollbar space-y-6">
                
                <!-- ãƒãƒ¼ã‚·ãƒ§ãƒ³ -->
                <div>
                    <h3 class="text-xs font-bold text-purple-400 uppercase tracking-wider mb-2">Consumables (æ¶ˆè€—å“)</h3>
                    <div id="shop-consumables" class="grid grid-cols-1 gap-2"></div>
                </div>

                <!-- æ–½è¨­ -->
                <div>
                    <h3 class="text-xs font-bold text-slate-400 uppercase tracking-wider mb-2">Buildings (æ–½è¨­)</h3>
                    <div id="shop-buildings" class="space-y-2"></div>
                </div>

                <!-- è»¢ç”Ÿè¨­å®š -->
                <div class="mt-8 p-4 border border-red-900/50 bg-red-900/10 rounded-lg">
                    <h3 class="font-bold text-red-400 mb-2">Rebirth (è»¢ç”Ÿ)</h3>
                    <p class="text-xs text-red-200/70 mb-4">
                        ã‚¹ãƒ©ã‚¤ãƒ ã€æ–½è¨­ã€ã‚¹ãƒ†ãƒ¼ã‚¸é€²è¡Œã‚’ãƒªã‚»ãƒƒãƒˆã—ã€ç²å¾—ç·ã‚¹ãƒ©ã‚¤ãƒ ã«å¿œã˜ãŸã€Œæ°¸ç¶šå€ç‡ã€ã‚’å¾—ã¦æœ€åˆã‹ã‚‰å§‹ã‚ã¾ã™ã€‚<br>
                        â€»ä»²é–“ã€é­”çŸ³ã€æ­¦å™¨ãƒ¬ãƒ™ãƒ«ã¯å¼•ãç¶™ãŒã‚Œã¾ã™ã€‚
                    </p>
                    <div class="text-center mb-2">
                        <span class="text-xs text-slate-400">ç¾åœ¨ã®ç²å¾—ãƒœãƒ¼ãƒŠã‚¹: </span>
                        <span id="rebirth-preview" class="font-bold text-yellow-400">+0%</span>
                    </div>
                    <!-- ãƒªãƒœãƒ¼ãƒ³ãƒœã‚¿ãƒ³ -->
                    <button id="btn-rebirth" onclick="rebirth()" class="w-full py-3 border border-red-500 text-red-500 hover:bg-red-500 hover:text-white rounded transition-colors font-bold disabled:opacity-50 disabled:hover:bg-transparent disabled:hover:text-red-500 disabled:cursor-not-allowed">
                        è»¢ç”Ÿã™ã‚‹ (æ¡ä»¶æœªé”)
                    </button>
                    <div id="rebirth-progress" class="w-full bg-slate-800 h-2 mt-2 rounded-full overflow-hidden hidden">
                        <div id="rebirth-bar" class="h-full bg-red-500 w-0 transition-all"></div>
                    </div>
                    <div class="text-center text-[10px] text-slate-500 mt-1">æ¡ä»¶: ç´¯è¨ˆ100ä¸‡ã‚¹ãƒ©ã‚¤ãƒ ç²å¾—</div>
                </div>

                <!-- ãƒ‡ãƒ¼ã‚¿ãƒªã‚»ãƒƒãƒˆ -->
                <div class="text-right pt-8">
                     <button onclick="hardReset()" class="text-xs text-slate-600 underline hover:text-slate-400">å…¨ãƒ‡ãƒ¼ã‚¿ã‚’å®Œå…¨æ¶ˆå»</button>
                </div>
            </div>
        </div>
    </main>

    <!-- ãƒ•ãƒƒã‚¿ãƒ¼ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ (ã‚¿ãƒ–ãƒœã‚¿ãƒ³) -->
    <nav class="bg-slate-800 border-t border-slate-700 h-16 shrink-0 flex justify-around items-center z-50">
        <button onclick="switchTab('main')" class="nav-btn flex flex-col items-center justify-center w-full h-full text-blue-400 active:bg-slate-700 relative">
            <span class="text-xl">ğŸ </span>
            <span class="text-[10px] font-bold mt-1">ãƒ¡ã‚¤ãƒ³</span>
        </button>
        <button onclick="switchTab('battle')" class="nav-btn flex flex-col items-center justify-center w-full h-full text-slate-400 active:bg-slate-700 relative">
            <span class="text-xl">âš”ï¸</span>
            <span class="text-[10px] font-bold mt-1">æˆ¦é—˜</span>
            <div id="badge-battle" class="nav-badge"></div>
        </button>
        <button onclick="switchTab('gacha')" class="nav-btn flex flex-col items-center justify-center w-full h-full text-slate-400 active:bg-slate-700 relative">
            <span class="text-xl">ğŸ”®</span>
            <span class="text-[10px] font-bold mt-1">ã‚¬ãƒãƒ£</span>
            <div id="badge-gacha" class="nav-badge"></div>
        </button>
        <button onclick="switchTab('shop')" class="nav-btn flex flex-col items-center justify-center w-full h-full text-slate-400 active:bg-slate-700 relative">
            <span class="text-xl">ğŸ›’</span>
            <span class="text-[10px] font-bold mt-1">ã‚·ãƒ§ãƒƒãƒ—</span>
            <div id="badge-shop" class="nav-badge"></div>
        </button>
    </nav>

    <!-- ã‚¬ãƒãƒ£çµæœãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div id="gacha-modal" class="fixed inset-0 bg-black/80 z-[100] hidden flex items-center justify-center p-4" onclick="this.classList.add('hidden')">
        <div class="bg-slate-800 p-8 rounded-xl border border-slate-600 max-w-sm w-full text-center card-shine" onclick="event.stopPropagation()">
            <div id="gacha-result-rarity" class="text-2xl font-black mb-2 text-yellow-400">SSR</div>
            <div id="gacha-result-icon" class="text-6xl mb-4 animate-bounce">ğŸ‰</div>
            <div id="gacha-result-name" class="text-xl font-bold text-white mb-2">ãƒ‰ãƒ©ã‚´ãƒ³ãƒ»ã‚¹ãƒ©ã‚¤ãƒ </div>
            <div id="gacha-result-desc" class="text-sm text-slate-300 mb-6">æ”»æ’ƒåŠ›+50%ã®å¼·æ•µï¼</div>
            <button onclick="document.getElementById('gacha-modal').classList.add('hidden')" class="bg-blue-600 text-white px-6 py-2 rounded hover:bg-blue-500 w-full">OK</button>
        </div>
    </div>

    <script>
        /* --- å®šæ•°ãƒ»ãƒ‡ãƒ¼ã‚¿ --- */
        const REBIRTH_REQ = 1000000; // è»¢ç”Ÿã«å¿…è¦ãªç´¯è¨ˆã‚¹ãƒ©ã‚¤ãƒ æ•° (1M)

        const BUILDINGS = [
            { id: 'stick', name: 'æœ¨ã®æ£’', icon: 'ğŸªµ', baseCost: 15, baseProd: 0.1, desc: 'ã¤ã¤ãã¨å°‘ã—ã‚¹ãƒ©ã‚¤ãƒ ãŒå¢—ãˆã‚‹' },
            { id: 'kid', name: 'æ‘ã®å­ä¾›', icon: 'ğŸ‘¦', baseCost: 100, baseProd: 1, desc: 'ãŠå°é£ã„ã‚’ã‚ã’ã¦é›‡ã£ãŸå­ä¾›' },
            { id: 'ranch', name: 'ã‚¹ãƒ©ã‚¤ãƒ ç‰§å ´', icon: 'ğŸ›–', baseCost: 1100, baseProd: 12, desc: 'æ”¾ã—é£¼ã„æ–½è¨­ã€‚é¤Œã¯æ°´ã§OK' }, // Prod UP
            { id: 'flask', name: 'éŒ¬é‡‘ãƒ•ãƒ©ã‚¹ã‚³', icon: 'âš—ï¸', baseCost: 12000, baseProd: 60, desc: 'ç§‘å­¦ã¨é­”æ³•ã®èåˆ' }, // Prod UP
            { id: 'summon', name: 'å¤ä»£ã®å¬å–šé™£', icon: 'ğŸ”®', baseCost: 130000, baseProd: 350, desc: 'ç•°ä¸–ç•Œã‹ã‚‰å‘¼ã³å‡ºã™' }, // Prod UP
            { id: 'planet', name: 'ã‚¹ãƒ©ã‚¤ãƒ æƒ‘æ˜Ÿ', icon: 'ğŸª', baseCost: 1400000, baseProd: 2000, desc: 'æ˜Ÿã”ã¨ã‚¹ãƒ©ã‚¤ãƒ åŒ–' } // Prod UP
        ];

        // ãƒ¦ãƒ‹ãƒƒãƒˆå®šç¾© (ã‚¬ãƒãƒ£)
        // å¤‰æ›´ï¼šä»²é–“ã®Dpsã¨Clickã¯çµ±åˆã—ã¦ã€ŒClick Powerï¼ˆé€£æºæ”»æ’ƒï¼‰ã€ã¨ã—ã¦è¨ˆç®—ã™ã‚‹
        const UNITS = [
            { id: 'u1', name: 'ã‚¹ãƒ©ã‚¤ãƒ å…µ', rarity: 'N', icon: 'ğŸ—¡ï¸', chance: 60, baseDps: 5, baseClick: 2, desc: 'å‰£ã‚’æŒã£ãŸã‚¹ãƒ©ã‚¤ãƒ ' },
            { id: 'u2', name: 'ã‚¹ãƒ©ã‚¤ãƒ å¼“å…µ', rarity: 'N', icon: 'ğŸ¹', chance: 60, baseDps: 8, baseClick: 1, desc: 'é ãã‹ã‚‰ç‹™ã„æ’ƒã¤' },
            { id: 'u3', name: 'ã‚¹ãƒ©ã‚¤ãƒ é­”æ³•ä½¿ã„', rarity: 'R', icon: 'ğŸ§™', chance: 30, baseDps: 25, baseClick: 5, desc: 'ãƒ•ã‚¡ã‚¤ã‚¢ãƒœãƒ¼ãƒ«ï¼' },
            { id: 'u4', name: 'ã‚¹ãƒ©ã‚¤ãƒ é¨å£«', rarity: 'R', icon: 'ğŸ›¡ï¸', chance: 30, baseDps: 15, baseClick: 10, desc: 'ç¡¬ã„é§ã‚’ç€ã¦ã„ã‚‹' },
            { id: 'u5', name: 'ãƒ¡ã‚«ãƒ»ã‚¹ãƒ©ã‚¤ãƒ ', rarity: 'SR', icon: 'ğŸ¤–', chance: 9, baseDps: 80, baseClick: 20, desc: 'ç§‘å­¦ã®åŠ›ã ï¼' },
            { id: 'u6', name: 'ãƒ‰ãƒ©ã‚´ãƒ³ãƒ»ã‚¹ãƒ©ã‚¤ãƒ ', rarity: 'SSR', icon: 'ğŸ‰', chance: 1, baseDps: 300, baseClick: 100, desc: 'æœ€å¼·ã®ç”Ÿç‰©...ã‹ã‚‚' }
        ];

        // æ­¦å™¨å®šç¾©
        const WEAPONS = [
            { id: 'w_wood', name: 'æœ¨ã®å‰£', icon: 'ğŸ—¡ï¸', baseCost: 5, basePower: 2, desc: 'ç·´ç¿’ç”¨ã®å‰£ã€‚' },
            { id: 'w_iron', name: 'é‰„ã®å‰£', icon: 'âš”ï¸', baseCost: 50, basePower: 15, desc: 'ä¸€èˆ¬çš„ã ãŒé ¼ã‚Šã«ãªã‚‹ã€‚' },
            { id: 'w_silver', name: 'ç™½éŠ€ã®ãƒ¬ã‚¤ãƒ”ã‚¢', icon: 'ğŸ¤º', baseCost: 300, basePower: 80, desc: 'ç¾ã—ãé‹­ã„ä¸€æŒ¯ã‚Šã€‚' },
            { id: 'w_hero', name: 'å‹‡è€…ã®å‰£', icon: 'âœ¨', baseCost: 2000, basePower: 500, desc: 'ä¼èª¬ã®å‹‡è€…ãŒä½¿ã£ã¦ã„ãŸå‰£ã€‚' },
            { id: 'w_demon', name: 'é­”å‰£ã‚°ãƒ©ãƒ ', icon: 'ğŸ‘¿', baseCost: 10000, basePower: 3000, desc: 'å‘ªã‚ã‚Œã¦ã„ã‚‹ãŒå¼·åŠ›ç„¡æ¯”ã€‚' }
        ];

        const CONSUMABLES = [
            {
                id: 'redPotion', name: 'èµ¤ã®ãƒãƒ¼ã‚·ãƒ§ãƒ³', icon: 'ğŸ§ª', baseCost: 1000,
                desc: '30ç§’é–“ã€ç”Ÿç”£3å€ (CD:60s)',
                duration: 30, cooldown: 60,
                onBuy: () => addBuff('frenzy', 30, 3)
            },
            {
                id: 'strPotion', name: 'åŠ›ã®ãƒãƒ¼ã‚·ãƒ§ãƒ³', icon: 'ğŸ’ª', baseCost: 5000,
                desc: '60ç§’é–“ã€æˆ¦é—˜åŠ›2å€ (CD:120s)',
                duration: 60, cooldown: 120,
                onBuy: () => addBuff('strength', 60, 2)
            },
            {
                id: 'goldPotion', name: 'é»„ã®ãƒãƒ¼ã‚·ãƒ§ãƒ³', icon: 'âœ¨', baseCost: 10000,
                desc: '5åˆ†åˆ†ã®ã‚¹ãƒ©ã‚¤ãƒ å³ã‚²ãƒƒãƒˆ (CD:60s)',
                duration: 0, cooldown: 60,
                onBuy: () => {
                    const gain = Math.max(calculateSpS() * 300, 1000);
                    addSlimes(gain);
                    spawnText(`+${beautify(gain)}`, window.innerWidth/2, window.innerHeight/2, 'text-yellow-400');
                }
            }
        ];

        /* --- ã‚²ãƒ¼ãƒ çŠ¶æ…‹ --- */
        let game = {
            slimes: 0,
            totalSlimes: 0,
            gems: 0,
            buildings: {},
            units: {}, 
            weapons: {},
            gachaCount: 0,
            rebirthCount: 0,
            battleStage: 1,
            lastSave: Date.now()
        };

        // åˆæœŸåŒ–ãƒ˜ãƒ«ãƒ‘ãƒ¼
        BUILDINGS.forEach(b => { if(game.buildings[b.id] === undefined) game.buildings[b.id] = 0; });
        WEAPONS.forEach(w => { if(game.weapons[w.id] === undefined) game.weapons[w.id] = 0; });

        // ä¸€æ™‚çŠ¶æ…‹
        let lastTick = performance.now();
        let activeBuffs = {};
        let cooldowns = {};
        let battle = {
            hp: 10,
            maxHp: 10,
            enemyId: 'slime',
            auto: false
        };
        let saveInterval;

        /* --- DOMã‚­ãƒ£ãƒƒã‚·ãƒ¥ --- */
        const $ = (id) => document.getElementById(id);
        const els = {
            slimes: $('res-slimes'), sps: $('res-sps'), gems: $('res-gems'),
            effectLayer: $('effect-layer'),
            enemyHpBar: $('enemy-hp-bar'), enemyHpText: $('enemy-hp-text'),
            enemyVisual: $('enemy-visual'), battleStage: $('battle-stage'),
            battleDps: $('battle-dps'),
            gachaCost: $('gacha-cost'), unitList: $('unit-list'), weaponList: $('weapon-list'),
            shopBuildings: $('shop-buildings'), shopConsumables: $('shop-consumables'),
            rebirthPreview: $('rebirth-preview'), statRebirth: $('stat-rebirth'), statClick: $('stat-click'),
            badgeGacha: $('badge-gacha'), badgeShop: $('badge-shop'), badgeBattle: $('badge-battle'),
            btnRebirth: $('btn-rebirth'), rebirthProgress: $('rebirth-progress'), rebirthBar: $('rebirth-bar')
        };

        /* --- ã‚³ã‚¢ãƒ­ã‚¸ãƒƒã‚¯ --- */
        
        function init() {
            loadGame();
            // ãƒ‡ãƒ¼ã‚¿æ•´åˆæ€§
            UNITS.forEach(u => { if (!game.units[u.id]) game.units[u.id] = { level: 0, count: 0 }; });
            WEAPONS.forEach(w => { if (!game.weapons[w.id]) game.weapons[w.id] = 0; });
            
            resetBattle(game.battleStage);
            renderShop();
            renderUnitList();
            renderWeaponList(); 
            updateResources();
            updateGachaButton();

            $('main-slime').addEventListener('pointerdown', (e) => handleMainClick(e));
            $('enemy-container').addEventListener('pointerdown', (e) => handleEnemyClick(e));
            $('auto-battle-check').addEventListener('change', (e) => { battle.auto = e.target.checked; });

            requestAnimationFrame(gameLoop);
            saveInterval = setInterval(saveGame, 30000);
        }

        function gameLoop(timestamp) {
            const dt = (timestamp - lastTick) / 1000;
            lastTick = timestamp;

            if (dt > 0) {
                const sps = calculateSpS();
                if (sps > 0) addSlimes(sps * dt);

                // è‡ªå‹•æ”»æ’ƒãƒ­ã‚¸ãƒƒã‚¯ã‚’å‰Šé™¤
                // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ãŒã‚¯ãƒªãƒƒã‚¯ã—ãªã„é™ã‚Šãƒ€ãƒ¡ãƒ¼ã‚¸ã¯å…¥ã‚‰ãªã„
                
                if ($('tab-battle').style.display !== 'none') {
                    // è¡¨ç¤ºæ›´æ–°ã®ã¿è¡Œã†
                    const dps = calculateTotalClickPower();
                    els.battleDps.textContent = beautify(dps);
                }
            }

            updateBuffs();
            updateCooldowns();
            updateResources();
            updateShopButtons();
            updateWeaponButtons(); 
            updateGachaButton();
            updateRebirthUI();
            
            requestAnimationFrame(gameLoop);
        }

        /* --- è¨ˆç®—ç³» --- */

        function getRebirthMultiplier() {
            if (game.totalSlimes < 1000) return 1;
            return 1 + Math.sqrt(game.totalSlimes / 1000) * 0.1;
        }

        function calculateSpS() {
            let sps = 0;
            BUILDINGS.forEach(b => sps += b.baseProd * (game.buildings[b.id] || 0));
            if (activeBuffs['frenzy']) sps *= activeBuffs['frenzy'].val;
            sps *= getRebirthMultiplier();
            return sps;
        }

        // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®ã‚¯ãƒªãƒƒã‚¯åŠ›ï¼ˆæ­¦å™¨ + ä»²é–“ã®å…¨ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ï¼‰
        function calculateTotalClickPower() {
            let power = 1;
            // ãƒ¦ãƒ‹ãƒƒãƒˆãƒœãƒ¼ãƒŠã‚¹ï¼ˆDPSã‚‚Clickã‚‚å…¨éƒ¨ã‚¯ãƒªãƒƒã‚¯æ”»æ’ƒåŠ›ã«å¤‰æ›ï¼‰
            UNITS.forEach(u => {
                const data = game.units[u.id];
                if (data && data.count > 0) {
                    power += (u.baseClick + u.baseDps) * data.level * data.count;
                }
            });
            // æ­¦å™¨ãƒœãƒ¼ãƒŠã‚¹
            WEAPONS.forEach(w => {
                const lv = game.weapons[w.id];
                if (lv > 0) power += w.basePower * lv;
            });
            
            // ãƒãƒ•
            if (activeBuffs['strength']) power *= activeBuffs['strength'].val;
            
            // è»¢ç”Ÿ
            power *= getRebirthMultiplier();
            
            return Math.max(1, power);
        }

        function addSlimes(amount) {
            game.slimes += amount;
            game.totalSlimes += amount;
        }

        /* --- ãƒãƒˆãƒ«ã‚·ã‚¹ãƒ†ãƒ  --- */

        function resetBattle(stage) {
            game.battleStage = stage;
            // æ•µHPè¨ˆç®—
            battle.maxHp = Math.floor(50 * Math.pow(1.6, stage - 1));
            battle.hp = battle.maxHp;
            const emojis = ['ğŸ‘¾', 'ğŸ‘»', 'ğŸ’€', 'ğŸ‘¹', 'ğŸ‘½', 'ğŸ¤–', 'ğŸ¦–'];
            els.enemyVisual.textContent = emojis[(stage - 1) % emojis.length];
            updateEnemyUI();
        }

        function handleEnemyClick(e) {
            const dmg = calculateTotalClickPower();
            damageEnemy(dmg);
            spawnText(`-${beautify(dmg)}`, e.clientX, e.clientY, 'text-red-500', true);
            els.enemyVisual.classList.remove('shake');
            void els.enemyVisual.offsetWidth;
            els.enemyVisual.classList.add('shake');
        }

        function damageEnemy(amount) {
            if (battle.hp <= 0) return;
            battle.hp -= amount;
            if (battle.hp <= 0) {
                battle.hp = 0;
                winBattle();
            }
            updateEnemyUI();
        }

        function winBattle() {
            const gemDrop = Math.floor(Math.random() * 2) + 1 + Math.floor(game.battleStage / 5);
            const slimeDrop = calculateSpS() * 2 + (game.battleStage * 50);
            
            game.gems += gemDrop;
            addSlimes(slimeDrop);
            spawnText(`Victory! +${gemDrop} Gems`, window.innerWidth/2, window.innerHeight/3, 'text-purple-400 text-2xl');
            setTimeout(() => {
                if (battle.auto) resetBattle(game.battleStage + 1);
                else resetBattle(game.battleStage);
            }, 500);
        }

        function updateEnemyUI() {
            const pct = (battle.hp / battle.maxHp) * 100;
            els.enemyHpBar.style.width = `${pct}%`;
            els.enemyHpText.textContent = `${beautify(Math.ceil(battle.hp))}/${beautify(battle.maxHp)}`;
            els.battleStage.textContent = game.battleStage;
        }

        /* --- æ­¦å™¨å¼·åŒ–ã‚·ã‚¹ãƒ†ãƒ  --- */

        function renderWeaponList() {
            els.weaponList.innerHTML = '';
            WEAPONS.forEach(w => {
                const div = document.createElement('div');
                div.id = `weapon-row-${w.id}`;
                div.className = "bg-slate-700 p-2 rounded flex items-center gap-3 border border-slate-600";
                div.innerHTML = `
                    <div class="text-2xl">${w.icon}</div>
                    <div class="flex-1">
                        <div class="flex justify-between items-center">
                            <div class="text-sm font-bold text-slate-200">${w.name}</div>
                            <div class="text-xs text-slate-400">Lv.<span id="w-lv-${w.id}">0</span></div>
                        </div>
                        <div class="text-[10px] text-slate-400">${w.desc} (ATK+${beautify(w.basePower)})</div>
                    </div>
                    <button onclick="upgradeWeapon('${w.id}')" id="btn-weapon-${w.id}" class="text-xs text-white px-3 py-2 rounded transition-colors bg-slate-600 disabled:opacity-50">
                        UP <br> <span id="w-cost-${w.id}" class="font-mono text-[10px]">0</span> Gem
                    </button>
                `;
                els.weaponList.appendChild(div);
            });
        }

        function updateWeaponButtons() {
            let canBuy = false;
            WEAPONS.forEach(w => {
                const lv = game.weapons[w.id];
                const cost = Math.floor(w.baseCost * Math.pow(1.3, lv));
                $(`w-lv-${w.id}`).textContent = lv;
                $(`w-cost-${w.id}`).textContent = beautify(cost);
                
                const btn = $(`btn-weapon-${w.id}`);
                if (game.gems >= cost) {
                    btn.disabled = false;
                    btn.classList.remove('bg-slate-600');
                    btn.classList.add('bg-blue-600', 'hover:bg-blue-500', 'can-buy');
                    canBuy = true;
                } else {
                    btn.disabled = true;
                    btn.classList.add('bg-slate-600');
                    btn.classList.remove('bg-blue-600', 'hover:bg-blue-500', 'can-buy');
                }
            });
            els.badgeBattle.classList.toggle('active', canBuy);
        }

        function upgradeWeapon(id) {
            const w = WEAPONS.find(x => x.id === id);
            const lv = game.weapons[id];
            const cost = Math.floor(w.baseCost * Math.pow(1.3, lv));
            if (game.gems >= cost) {
                game.gems -= cost;
                game.weapons[id]++;
                updateWeaponButtons();
            }
        }

        /* --- ã‚¬ãƒãƒ£ & ãƒ¦ãƒ‹ãƒƒãƒˆ --- */
        function getGachaCost() { return Math.floor(100 * Math.pow(1.1, game.gachaCount)); }
        
        function pullGacha(times) {
            const cost = getGachaCost();
            if (game.slimes < cost) return;
            game.slimes -= cost;
            game.gachaCount += times;
            
            let resultUnit = null;
            let isNew = false;
            let bonusGem = 0;
            const rand = Math.random() * 100;
            let rarity = 'N';
            if (rand < 1) rarity = 'SSR';
            else if (rand < 10) rarity = 'SR';
            else if (rand < 40) rarity = 'R';
            const pool = UNITS.filter(u => u.rarity === rarity);
            resultUnit = pool[Math.floor(Math.random() * pool.length)];

            if (game.units[resultUnit.id].count === 0) {
                game.units[resultUnit.id].count = 1;
                game.units[resultUnit.id].level = 1;
                isNew = true;
            } else {
                game.units[resultUnit.id].count++;
                bonusGem = (rarity === 'SSR' ? 10 : rarity === 'SR' ? 5 : rarity === 'R' ? 2 : 1);
                game.gems += bonusGem;
            }
            showGachaResult(resultUnit, isNew, bonusGem);
            updateGachaButton();
            renderUnitList();
        }

        function showGachaResult(unit, isNew, bonusGem) {
            $('gacha-result-rarity').textContent = unit.rarity;
            $('gacha-result-rarity').className = `text-2xl font-black mb-2 ${getRarityColor(unit.rarity)}`;
            $('gacha-result-icon').textContent = unit.icon;
            $('gacha-result-name').textContent = unit.name;
            $('gacha-result-desc').textContent = isNew ? "NEW JOIN!" : `æ—¢ã«ä»²é–“ã§ã™ã€‚é­”çŸ³+${bonusGem}`;
            $('gacha-modal').classList.remove('hidden');
        }

        function upgradeUnit(id) {
            const u = game.units[id];
            const cost = u.level * 5;
            if (game.gems >= cost) {
                game.gems -= cost;
                u.level++;
                renderUnitList();
            }
        }
        
        function updateResources() {
            els.slimes.textContent = beautify(Math.floor(game.slimes));
            els.sps.textContent = beautify(calculateSpS(), 1) + "/s";
            els.gems.textContent = game.gems;
            els.statRebirth.textContent = `x${beautify(getRebirthMultiplier(), 2)}`;
            els.statClick.textContent = beautify(calculateTotalClickPower());
        }

        function updateGachaButton() {
            const cost = getGachaCost();
            const btn = $('btn-gacha-1');
            const txt = $('gacha-btn-text');
            const canBuy = game.slimes >= cost;
            els.badgeGacha.classList.toggle('active', canBuy);
            if (canBuy) {
                btn.disabled = false;
                btn.classList.remove('opacity-50', 'bg-slate-700', 'text-slate-400', 'border-slate-600');
                btn.classList.add('bg-blue-600', 'text-white', 'hover:bg-blue-500', 'border-blue-400', 'can-buy');
                txt.innerHTML = `1å›å¬å–š (<span class="font-mono">${beautify(cost)}</span> Slimes)`;
            } else {
                btn.disabled = true;
                btn.classList.add('opacity-50', 'bg-slate-700', 'text-slate-400', 'border-slate-600');
                btn.classList.remove('bg-blue-600', 'text-white', 'hover:bg-blue-500', 'border-blue-400', 'can-buy');
                const diff = cost - game.slimes;
                txt.innerHTML = `ä¸è¶³: ${beautify(diff)} Slimes (Cost: ${beautify(cost)})`;
            }
        }

        function renderUnitList() {
            els.unitList.innerHTML = '';
            let hasUnit = false;
            UNITS.forEach(u => {
                const data = game.units[u.id];
                if (data && data.count > 0) {
                    hasUnit = true;
                    const div = document.createElement('div');
                    const cost = data.level * 5;
                    const canUp = game.gems >= cost;
                    div.className = "bg-slate-800 border border-slate-700 p-3 rounded flex items-center gap-3";
                    
                    // DPS + Clickã‚’çµ±åˆã—ã¦è¡¨ç¤º
                    const totalPower = (u.baseClick + u.baseDps) * data.level * data.count;
                    
                    div.innerHTML = `
                        <div class="text-3xl">${u.icon}</div>
                        <div class="flex-1">
                            <div class="flex justify-between items-center">
                                <div class="font-bold text-slate-200">${u.name} <span class="text-xs ${getRarityColor(u.rarity)}">[${u.rarity}]</span></div>
                                <div class="text-xs text-slate-400">Lv.${data.level} (x${data.count})</div>
                            </div>
                            <div class="text-[10px] text-slate-400">Click Power +${beautify(totalPower)} (é€£æºæ”»æ’ƒ)</div>
                        </div>
                        <button onclick="upgradeUnit('${u.id}')" class="text-xs text-white px-3 py-2 rounded transition-colors disabled:opacity-50 disabled:cursor-not-allowed ${canUp ? 'bg-purple-600 hover:bg-purple-500 can-buy' : 'bg-slate-700'}" ${!canUp ? 'disabled' : ''}>
                            UP (${cost} Gem)
                        </button>
                    `;
                    els.unitList.appendChild(div);
                }
            });
            if (!hasUnit) els.unitList.innerHTML = '<div class="text-center text-slate-500 py-4">ã¾ã ä»²é–“ãŒã„ã¾ã›ã‚“</div>';
        }

        function getRarityColor(r) {
            if(r === 'SSR') return 'text-yellow-400';
            if(r === 'SR') return 'text-red-400';
            if(r === 'R') return 'text-blue-400';
            return 'text-slate-400';
        }

        function handleMainClick(e) {
            const amount = calculateTotalClickPower();
            addSlimes(amount);
            const s = $('main-slime');
            s.classList.remove('anim-click');
            void s.offsetWidth;
            s.classList.add('anim-click');
            spawnText(`+${beautify(amount)}`, e.clientX, e.clientY);
        }

        function spawnText(text, x, y, colorClass = 'text-white', isDamage = false) {
            const el = document.createElement('div');
            el.textContent = text;
            el.className = `damage-text text-2xl ${colorClass}`;
            el.style.left = `${x}px`;
            el.style.top = `${y}px`;
            const rx = (Math.random() - 0.5) * 30;
            el.style.transform = `translateX(${rx}px)`;
            els.effectLayer.appendChild(el);
            setTimeout(() => el.remove(), 800);
        }

        function renderShop() {
            els.shopConsumables.innerHTML = '';
            CONSUMABLES.forEach(item => {
                const div = document.createElement('div');
                div.id = `btn-item-${item.id}`;
                div.className = "bg-slate-800 p-2 rounded border border-slate-700 cursor-pointer flex justify-between items-center group active:scale-95 transition-all relative overflow-hidden";
                div.onclick = () => buyConsumable(item.id);
                div.innerHTML = `
                    <div class="flex items-center gap-3 z-10">
                        <div class="text-2xl">${item.icon}</div>
                        <div>
                            <div class="text-sm font-bold text-purple-200">${item.name}</div>
                            <div class="text-[10px] text-slate-400">${item.desc}</div>
                        </div>
                    </div>
                    <div class="text-right z-10">
                        <div class="text-xs font-bold text-yellow-400">${beautify(item.baseCost)}</div>
                    </div>
                    <div id="cd-overlay-${item.id}" class="absolute inset-0 bg-black/60 z-20 flex items-center justify-center text-white font-bold hidden"></div>
                `;
                els.shopConsumables.appendChild(div);
            });
            els.shopBuildings.innerHTML = '';
            BUILDINGS.forEach(b => {
                const div = document.createElement('div');
                div.id = `btn-build-${b.id}`;
                div.className = "bg-slate-800 p-2 rounded border border-slate-700 cursor-pointer flex justify-between items-center active:scale-95 transition-all";
                div.onclick = () => buyBuilding(b.id);
                div.innerHTML = `
                    <div class="flex items-center gap-3">
                        <div class="text-2xl">${b.icon}</div>
                        <div>
                            <div class="font-bold text-blue-100 text-xs">${b.name}</div>
                            <div class="text-[10px] text-slate-400">+${beautify(b.baseProd)}/s</div>
                        </div>
                    </div>
                    <div class="text-right">
                        <div class="text-xs font-bold text-green-400">Cost: <span id="cost-${b.id}">0</span></div>
                        <div class="text-lg font-bold text-slate-500" id="count-${b.id}">0</div>
                    </div>
                `;
                els.shopBuildings.appendChild(div);
            });
        }

        function updateShopButtons() {
            let canBuyAnything = false;
            BUILDINGS.forEach(b => {
                const cost = Math.floor(b.baseCost * Math.pow(1.15, game.buildings[b.id]));
                $(`cost-${b.id}`).textContent = beautify(cost);
                $(`count-${b.id}`).textContent = game.buildings[b.id];
                const btn = $(`btn-build-${b.id}`);
                if (game.slimes >= cost) {
                    btn.classList.remove('opacity-50');
                    btn.classList.add('can-buy');
                    canBuyAnything = true;
                } else {
                    btn.classList.add('opacity-50');
                    btn.classList.remove('can-buy');
                }
            });
            CONSUMABLES.forEach(item => {
                const btn = $(`btn-item-${item.id}`);
                const overlay = $(`cd-overlay-${item.id}`);
                const now = Date.now();
                if (cooldowns[item.id] && cooldowns[item.id] > now) {
                    overlay.classList.remove('hidden');
                    const left = Math.ceil((cooldowns[item.id] - now) / 1000);
                    overlay.textContent = left + "s";
                    btn.style.pointerEvents = 'none';
                    btn.classList.remove('can-buy');
                } else {
                    overlay.classList.add('hidden');
                    btn.style.pointerEvents = 'auto';
                    if (game.slimes >= item.baseCost) {
                         btn.classList.remove('opacity-50');
                         btn.classList.add('can-buy');
                         canBuyAnything = true;
                    } else {
                        btn.classList.add('opacity-50');
                        btn.classList.remove('can-buy');
                    }
                }
            });
            els.badgeShop.classList.toggle('active', canBuyAnything);
        }
        
        function updateRebirthUI() {
            const multi = getRebirthMultiplier();
            els.rebirthPreview.textContent = `x${beautify(multi, 2)}`;

            const btn = els.btnRebirth;
            const bar = els.rebirthBar;
            const progressContainer = els.rebirthProgress;
            
            if (game.totalSlimes >= REBIRTH_REQ) {
                btn.disabled = false;
                btn.textContent = "è»¢ç”Ÿã™ã‚‹ (æ¡ä»¶é”æˆï¼)";
                btn.classList.remove('locked-btn');
                progressContainer.classList.add('hidden');
            } else {
                btn.disabled = true;
                btn.textContent = `è»¢ç”Ÿã«ã¯ã‚ã¨ ${beautify(REBIRTH_REQ - game.totalSlimes)} ã‚¹ãƒ©ã‚¤ãƒ å¿…è¦`;
                btn.classList.add('locked-btn');
                
                // ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹ãƒãƒ¼æ›´æ–°
                progressContainer.classList.remove('hidden');
                const pct = Math.min(100, (game.totalSlimes / REBIRTH_REQ) * 100);
                bar.style.width = `${pct}%`;
            }
        }

        function buyBuilding(id) {
            const b = BUILDINGS.find(x => x.id === id);
            const cost = Math.floor(b.baseCost * Math.pow(1.15, game.buildings[id]));
            if (game.slimes >= cost) {
                game.slimes -= cost;
                game.buildings[id]++;
            }
        }

        function buyConsumable(id) {
            const item = CONSUMABLES.find(x => x.id === id);
            if (game.slimes >= item.baseCost) {
                game.slimes -= item.baseCost;
                item.onBuy();
                if (item.cooldown) cooldowns[item.id] = Date.now() + item.cooldown * 1000;
                updateShopButtons();
            }
        }

        function rebirth() {
            if (game.totalSlimes < REBIRTH_REQ) return;
            if (!confirm("è»¢ç”Ÿã—ã¾ã™ã‹ï¼Ÿ\nã‚¹ãƒ©ã‚¤ãƒ ã¨æ–½è¨­ã€ã‚¹ãƒ†ãƒ¼ã‚¸é€²è¡Œã¯ãƒªã‚»ãƒƒãƒˆã•ã‚Œã¾ã™ãŒã€\nä»²é–“ã€é­”çŸ³ã€æ­¦å™¨ãƒ¬ãƒ™ãƒ«ã¯å¼•ãç¶™ãŒã‚Œã¾ã™ã€‚")) return;
            game.slimes = 0;
            BUILDINGS.forEach(b => game.buildings[b.id] = 0);
            game.battleStage = 1;
            game.rebirthCount++;
            saveGame();
            location.reload();
        }

        function addBuff(type, duration, val) {
            const now = Date.now();
            activeBuffs[type] = { end: now + duration * 1000, val: val };
        }

        function updateBuffs() {
            const now = Date.now();
            const container = $('buff-container');
            container.innerHTML = '';
            Object.keys(activeBuffs).forEach(k => {
                if (activeBuffs[k].end > now) {
                    const left = Math.ceil((activeBuffs[k].end - now) / 1000);
                    const div = document.createElement('div');
                    div.className = "bg-yellow-500 text-black text-xs font-bold px-2 py-1 rounded animate-pulse";
                    div.textContent = k === 'strength' ? `STR x2: ${left}s` : `PROD x3: ${left}s`;
                    container.appendChild(div);
                }
            });
        }
        
        function updateCooldowns() {}

        function switchTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(el => el.style.display = 'none');
            const target = $(`tab-${tabName}`);
            target.style.display = 'flex';
            target.classList.remove('hidden');
            document.querySelectorAll('.nav-btn').forEach(btn => btn.classList.remove('text-blue-400'));
            document.querySelectorAll('.nav-btn').forEach(btn => btn.classList.add('text-slate-400'));
            event.currentTarget.classList.add('text-blue-400');
            event.currentTarget.classList.remove('text-slate-400');
        }

        function beautify(num, d=0) {
            if (num < 1000) return Math.floor(num * 10)/10;
            const units = ['k', 'M', 'B', 'T', 'Qa'];
            const order = Math.floor(Math.log10(num) / 3);
            if (order >= units.length + 1) return 'INF';
            return (num / Math.pow(1000, order)).toFixed(2) + units[order - 1];
        }

        function saveGame() {
            game.lastSave = Date.now();
            localStorage.setItem('slimeClickerRPG_v3', JSON.stringify(game));
        }

        function loadGame() {
            const saved = localStorage.getItem('slimeClickerRPG_v3');
            if (saved) {
                try {
                    const parsed = JSON.parse(saved);
                    game = { ...game, ...parsed };
                    const now = Date.now();
                    const diff = (now - game.lastSave) / 1000;
                    if (diff > 60) {
                        const gain = calculateSpS() * diff * 0.5;
                        if(gain > 0) {
                            addSlimes(gain);
                            alert(`ãŠã‹ãˆã‚Šãªã•ã„ï¼\nç•™å®ˆä¸­ã« ${beautify(gain)} ã‚¹ãƒ©ã‚¤ãƒ ç¨¼ãã¾ã—ãŸã€‚`);
                        }
                    }
                } catch (e) { console.error(e); }
            }
        }

        function hardReset() {
            if(confirm("æœ¬å½“ã«å…¨ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿå¾©å…ƒã§ãã¾ã›ã‚“ã€‚")) {
                localStorage.removeItem('slimeClickerRPG_v3');
                location.reload();
            }
        }

        window.onload = init;
    </script>
</body>
</html>
