<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>„Çπ„É©„Ç§„É†„ÇØ„É™„ÉÉ„Ç´„Éº (Slime Clicker)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=M+PLUS+Rounded+1c:wght@400;700&display=swap');

        body {
            font-family: 'M PLUS Rounded 1c', sans-serif;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
        }

        /* „Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥ÂÆöÁæ© */
        @keyframes jelly {
            0%, 100% { transform: scale(1, 1); }
            25% { transform: scale(0.9, 1.1); }
            50% { transform: scale(1.1, 0.9); }
            75% { transform: scale(0.95, 1.05); }
        }

        .slime-click-anim {
            animation: click-squish 0.1s ease-out;
        }

        @keyframes click-squish {
            0% { transform: scale(1); }
            50% { transform: scale(0.9); }
            100% { transform: scale(1); }
        }

        /* Â∑®Â§ß„Çπ„É©„Ç§„É† */
        .giant-slime {
            width: 200px;
            height: 180px;
            background: radial-gradient(circle at 30% 30%, #60a5fa, #2563eb);
            border-radius: 50% 50% 40% 40%;
            position: relative;
            box-shadow: 
                inset 10px 10px 20px rgba(255,255,255,0.4),
                inset -10px -20px 20px rgba(0,0,0,0.2),
                0 15px 30px rgba(37, 99, 235, 0.4);
            transition: transform 0.1s, filter 0.3s;
            cursor: pointer;
            z-index: 10;
        }

        .giant-slime::after {
            content: '';
            position: absolute;
            top: 15%;
            left: 20%;
            width: 25%;
            height: 15%;
            background: rgba(255,255,255,0.7);
            border-radius: 50%;
            transform: rotate(-45deg);
        }

        /* „Éñ„Éº„Çπ„ÉàÊôÇ„ÅÆÁô∫ÂÖâ„Ç®„Éï„Çß„ÇØ„Éà */
        .boost-active .giant-slime {
            filter: drop-shadow(0 0 15px #facc15) brightness(1.1);
            animation: jelly 0.5s infinite;
        }

        /* „Ç¥„Éº„É´„Éá„É≥„Çπ„É©„Ç§„É† */
        .golden-slime {
            position: absolute;
            width: 60px;
            height: 50px;
            background: radial-gradient(circle at 30% 30%, #fde047, #eab308);
            border-radius: 50% 50% 40% 40%;
            box-shadow: 0 0 15px #facc15;
            cursor: pointer;
            z-index: 100;
            animation: jelly 2s infinite, float 3s ease-in-out infinite;
            pointer-events: auto;
        }
        
        @keyframes float {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-10px); }
        }

        /* „Éù„ÉÉ„Éó„Ç¢„ÉÉ„ÉóÊï∞ÂÄ§ */
        .floating-number {
            position: absolute;
            font-weight: bold;
            color: white;
            pointer-events: none;
            animation: float-up 1s forwards;
            text-shadow: 0 2px 4px rgba(0,0,0,0.5);
            z-index: 20;
        }

        @keyframes float-up {
            0% { opacity: 1; transform: translateY(0) scale(1); }
            100% { opacity: 0; transform: translateY(-50px) scale(1.2); }
        }

        /* „Éë„Éº„ÉÜ„Ç£„ÇØ„É´ */
        .particle {
            position: absolute;
            border-radius: 50%;
            pointer-events: none;
            animation: particle-anim 0.8s forwards;
        }

        @keyframes particle-anim {
            0% { transform: translate(0, 0) scale(1); opacity: 1; }
            100% { transform: translate(var(--tx), var(--ty)) scale(0); opacity: 0; }
        }

        /* „Çπ„ÇØ„É≠„Éº„É´„Éê„Éº */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #1e293b; }
        ::-webkit-scrollbar-thumb { background: #475569; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #64748b; }
    </style>
</head>
<body class="bg-slate-900 text-slate-100 h-screen w-screen overflow-hidden flex flex-col md:flex-row">

    <!-- Â∑¶„Ç´„É©„É†: „É°„Ç§„É≥„Ç≤„Éº„É†„Ç®„É™„Ç¢ -->
    <section id="main-area" class="relative w-full md:w-5/12 h-1/2 md:h-full bg-slate-900 flex flex-col items-center justify-center border-b md:border-b-0 md:border-r border-slate-700 p-4 z-10">
        
        <!-- „Éê„ÉïË°®Á§∫„Ç®„É™„Ç¢ -->
        <div id="buff-container" class="absolute top-4 left-4 right-4 flex flex-wrap gap-2 justify-center z-20 pointer-events-none">
            <!-- JS„ÅßÁîüÊàê -->
        </div>

        <!-- Êï∞ÂÄ§Ë°®Á§∫ -->
        <div class="text-center mb-8 relative z-10">
            <div class="text-sm text-slate-400 font-bold uppercase tracking-wider mb-1">Slimes</div>
            <div id="score-display" class="text-5xl md:text-6xl font-bold text-blue-400 drop-shadow-lg tabular-nums">0</div>
            <div class="text-slate-400 mt-2 text-lg font-bold tabular-nums flex items-center justify-center gap-2">
                <span><span id="sps-display">0.0</span> /Áßí</span>
            </div>
        </div>

        <!-- Â∑®Â§ß„Çπ„É©„Ç§„É† -->
        <div class="relative flex items-center justify-center w-full h-64">
            <div id="giant-slime" class="giant-slime hover:scale-105 active:scale-95 transition-transform">
                <div class="absolute top-[35%] left-[25%] w-[10%] h-[10%] bg-slate-900 rounded-full opacity-70"></div>
                <div class="absolute top-[35%] right-[25%] w-[10%] h-[10%] bg-slate-900 rounded-full opacity-70"></div>
                <div class="absolute top-[55%] left-[45%] w-[10%] h-[5%] bg-slate-900 rounded-full opacity-50"></div>
            </div>
        </div>

        <!-- „Ç®„Éï„Çß„ÇØ„Éà„Ç≥„É≥„ÉÜ„Éä -->
        <div id="click-effect-container" class="absolute inset-0 pointer-events-none overflow-hidden"></div>
    </section>

    <!-- Âè≥„Ç´„É©„É†: „Ç∑„Éß„ÉÉ„Éó -->
    <section class="w-full md:w-7/12 h-1/2 md:h-full flex flex-col bg-slate-800">
        <div class="flex bg-slate-800 border-b border-slate-700 shrink-0">
            <div class="px-6 py-3 text-blue-400 font-bold border-b-2 border-blue-400 bg-slate-800/50">
                „Ç∑„Éß„ÉÉ„Éó (Shop)
            </div>
        </div>

        <div class="flex-1 overflow-y-auto p-2 md:p-4 space-y-6 custom-scrollbar">
            
            <!-- „Éù„Éº„Ç∑„Éß„É≥„ÉªÊ∂àËÄóÂìÅ -->
            <div id="consumables-section" class="hidden">
                <h3 class="text-xs font-bold text-purple-400 uppercase tracking-wider mb-2 flex items-center gap-2">
                    <span>üß™ Potions (Ê∂àËÄóÂìÅ)</span>
                    <span class="text-[10px] text-slate-500">‰ΩïÂ∫¶„Åß„ÇÇË≤∑„Åà„Åæ„Åô</span>
                </h3>
                <div id="consumables-container" class="grid grid-cols-1 gap-2">
                    <!-- JS„ÅßÁîüÊàê -->
                </div>
            </div>

            <!-- „Ç¢„ÉÉ„Éó„Ç∞„É¨„Éº„Éâ („É™„Çπ„ÉàÂΩ¢Âºè„Å´Â§âÊõ¥) -->
            <div id="upgrades-section" class="hidden">
                <h3 class="text-xs font-bold text-yellow-500 uppercase tracking-wider mb-2 flex items-center gap-2">
                    <span>‚ö° Upgrades (Âº∑Âåñ)</span>
                    <span class="text-[10px] text-slate-500">‰∏ÄÂ∫¶„Å†„Åë„ÅÆÊ∞∏Á∂öÂäπÊûú</span>
                </h3>
                <div id="upgrades-container" class="grid grid-cols-1 gap-2">
                    <!-- JS„ÅßÁîüÊàê: „É™„Çπ„ÉàÂΩ¢Âºè„Å´„Åó„Å¶Ë™¨ÊòéÊñá„ÇíÂ∏∏ÊôÇË°®Á§∫ -->
                </div>
            </div>

            <!-- ÊñΩË®≠„É™„Çπ„Éà -->
            <div>
                <h3 class="text-xs font-bold text-slate-400 uppercase tracking-wider mb-2 flex justify-between items-center px-1">
                    <span>Buildings (ÊñΩË®≠)</span>
                    <span class="text-[10px] bg-slate-700 px-2 py-1 rounded text-slate-300">Cost x1.15</span>
                </h3>
                <div id="buildings-container" class="space-y-2">
                    <!-- JS„ÅßÁîüÊàê -->
                </div>
            </div>
            
            <div class="pt-8 pb-4 flex justify-between items-center text-xs text-slate-500 border-t border-slate-700 mt-4">
                <span>Auto-saved locally.</span>
                <button onclick="hardReset()" class="text-red-500 hover:text-red-400 underline">„É™„Çª„ÉÉ„Éà</button>
            </div>
        </div>
    </section>

    <div id="golden-slime-container" class="fixed inset-0 pointer-events-none z-50 overflow-hidden"></div>

    <script>
        /* --- „Éá„Éº„ÇøÂÆöÁæ© --- */
        const BUILDINGS = [
            { id: 'stick', name: 'Êú®„ÅÆÊ£í', icon: 'ü™µ', baseCost: 15, baseProd: 0.1, desc: '„Å§„Å§„Åè„Å®Â∞ë„Åó„Çπ„É©„Ç§„É†„ÅåÂ¢ó„Åà„Çã„ÄÇ' },
            { id: 'kid', name: 'Êùë„ÅÆÂ≠ê‰æõ', icon: 'üë¶', baseCost: 100, baseProd: 1, desc: '„ÅäÂ∞èÈÅ£„ÅÑ„Çí„ÅÇ„Åí„Å¶Èõá„Å£„ÅüÂ≠ê‰æõ„ÄÇ' },
            { id: 'ranch', name: '„Çπ„É©„Ç§„É†ÁâßÂ†¥', icon: 'üõñ', baseCost: 1100, baseProd: 8, desc: '„Çπ„É©„Ç§„É†„ÇíÊîæ„ÅóÈ£º„ÅÑ„Å´„Åô„ÇãÊñΩË®≠„ÄÇ' },
            { id: 'flask', name: 'Èå¨ÈáëË°ìÂ∏´„ÅÆ„Éï„É©„Çπ„Ç≥', icon: '‚öóÔ∏è', baseCost: 12000, baseProd: 47, desc: 'ÁßëÂ≠¶„Å®È≠îÊ≥ï„ÅÆËûçÂêà„ÄÇ' },
            { id: 'summon', name: 'Âè§‰ª£„ÅÆÂè¨ÂñöÈô£', icon: 'üîÆ', baseCost: 130000, baseProd: 260, desc: 'Áï∞‰∏ñÁïå„Åã„Çâ„Çπ„É©„Ç§„É†„ÇíÂëº„Å≥Âá∫„Åô„ÄÇ' },
            { id: 'planet', name: '„Çπ„É©„Ç§„É†ÊÉëÊòü', icon: 'ü™ê', baseCost: 1400000, baseProd: 1400, desc: 'ÊÉëÊòü„Å≤„Å®„Å§„Çí‰∏∏„Åî„Å®Êé°Êéò„Åô„Çã„ÄÇ' }
        ];

        const UPGRADES = [
            // „ÇØ„É™„ÉÉ„ÇØÂº∑ÂåñÁ≥ª
            { 
                id: 'glove1', name: 'ÂéöÊâã„ÅÆËªçÊâã', icon: 'üß§', cost: 500, 
                desc: '„ÇØ„É™„ÉÉ„ÇØ„ÅßÂæó„Çâ„Çå„Çã„Çπ„É©„Ç§„É†„Åå +1 „Åï„Çå„Åæ„Åô„ÄÇ',
                condition: (g) => g.clicks >= 50,
                effectType: 'clickAdd', value: 1
            },
            { 
                id: 'glove2', name: '„Éë„ÉØ„Éº„Ç∞„É≠„Éº„Éñ', icon: 'ü•ä', cost: 5000, 
                desc: '„ÇØ„É™„ÉÉ„ÇØ„ÅßÂæó„Çâ„Çå„Çã„Çπ„É©„Ç§„É†„Åå +5 „Åï„Çå„Åæ„Åô„ÄÇ',
                condition: (g) => g.clicks >= 500,
                effectType: 'clickAdd', value: 5
            },
            { 
                id: 'clickPercent1', name: '„Çπ„É©„Ç§„É†„Å®„ÅÆÁµÜ', icon: '‚ù§Ô∏è', cost: 50000, 
                desc: 'ÊØéÁßíÁîüÁî£Èáè„ÅÆ 1% „Åå„ÇØ„É™„ÉÉ„ÇØ„Å´ËøΩÂä†„Åï„Çå„Åæ„Åô„ÄÇ',
                condition: (g) => g.totalSlimes >= 10000,
                effectType: 'clickPercent', value: 0.01
            },
            // ÁîüÁî£Âº∑ÂåñÁ≥ª
            { 
                id: 'hardenedFinger', name: 'Á°¨„ÅÑÊåáÂÖà', icon: 'üëÜ', cost: 2000, 
                desc: '„ÇØ„É™„ÉÉ„ÇØÂäπÁéá„Åå 2ÂÄç „Å´„Å™„Çä„Åæ„Åô„ÄÇ',
                condition: (g) => g.clicks >= 200,
                effectType: 'clickMult', value: 2
            },
            { 
                id: 'blueDye', name: 'Èùí„ÅÑÊüìÊñô', icon: 'üé®', cost: 11000, 
                desc: '„Äå„Çπ„É©„Ç§„É†ÁâßÂ†¥„Äç„ÅÆÁîüÁî£Èáè„Åå 2ÂÄç „Å´„Å™„Çä„Åæ„Åô„ÄÇ',
                condition: (g) => g.buildings['ranch'] >= 10,
                effectType: 'buildingMult', target: 'ranch', value: 2
            },
            { 
                id: 'fakeStone', name: 'Ë≥¢ËÄÖ„ÅÆÁü≥ÔºàÂÅΩÔºâ', icon: 'üíé', cost: 120000, 
                desc: 'ÂÖ®„Å¶„ÅÆÊñΩË®≠„ÅÆÁîüÁî£Èáè„Åå 1.1ÂÄç „Å´„Å™„Çä„Åæ„Åô„ÄÇ',
                condition: (g) => g.buildings['flask'] >= 20,
                effectType: 'globalMult', value: 1.1
            }
        ];

        const CONSUMABLES = [
            {
                id: 'redPotion', name: 'Ëµ§„ÅÆ„Éù„Éº„Ç∑„Éß„É≥', icon: 'üß™', baseCost: 1000,
                desc: '30ÁßíÈñì„ÄÅÂÖ®ÁîüÁî£Èáè„Åå 3ÂÄç „Å´„Å™„Çä„Åæ„Åô„ÄÇ',
                duration: 30,
                onBuy: (g) => addBuff('frenzy', 30, 3)
            },
            {
                id: 'bluePotion', name: 'Èùí„ÅÆ„Éù„Éº„Ç∑„Éß„É≥', icon: 'üíß', baseCost: 5000,
                desc: '30ÁßíÈñì„ÄÅ„ÇØ„É™„ÉÉ„ÇØÂäõ„Åå 5ÂÄç „Å´„Å™„Çä„Åæ„Åô„ÄÇ',
                duration: 30,
                onBuy: (g) => addBuff('clickFrenzy', 30, 5)
            },
            {
                id: 'goldPotion', name: 'ÈªÑ„ÅÆ„Éù„Éº„Ç∑„Éß„É≥', icon: '‚ú®', baseCost: 10000,
                desc: 'ÁèæÂú®„ÅÆÊØéÁßíÁîüÁî£Èáè„ÅÆ 300ÁßíÂàÜ „ÇíÂç≥Â∫ß„Å´Áç≤Âæó„Åó„Åæ„Åô„ÄÇ',
                duration: 0,
                onBuy: (g) => {
                    const sps = calculateSpS();
                    const amount = Math.max(sps * 300, 1000);
                    addSlimes(amount);
                    spawnFloatingText(`+${beautify(amount)}`, window.innerWidth/2, window.innerHeight/2);
                }
            }
        ];

        /* --- „Ç≤„Éº„É†Áä∂ÊÖã --- */
        let game = {
            slimes: 0,
            totalSlimes: 0,
            clicks: 0,
            buildings: {},
            upgrades: {},
            lastSave: Date.now()
        };
        
        // „Éê„ÉïÁÆ°ÁêÜÔºà„Çª„Éº„Éñ„Åó„Å™„ÅÑ‰∏ÄÊôÇÁöÑ„Å™„ÇÇ„ÅÆÔºâ
        let activeBuffs = {}; // { frenzy: { endTime: 123456789, multiplier: 3 } }

        // ÂàùÊúüÂåñ
        BUILDINGS.forEach(b => { if (game.buildings[b.id] === undefined) game.buildings[b.id] = 0; });
        UPGRADES.forEach(u => { if (game.upgrades[u.id] === undefined) game.upgrades[u.id] = false; });

        /* --- „Ç∑„Çπ„ÉÜ„É†Â§âÊï∞ --- */
        let lastTick = performance.now();
        let saveInterval;
        const els = {}; // DOM„Ç≠„É£„ÉÉ„Ç∑„É•

        /* --- ÂàùÊúüÂåñÂá¶ÁêÜ --- */
        function init() {
            // DOMË¶ÅÁ¥†ÂèñÂæó
            ['score-display', 'sps-display', 'giant-slime', 'buildings-container', 
             'upgrades-section', 'upgrades-container', 'consumables-section', 'consumables-container',
             'click-effect-container', 'golden-slime-container', 'buff-container', 'main-area'
            ].forEach(id => els[id] = document.getElementById(id));

            loadGame();
            renderShop(); // „Ç∑„Éß„ÉÉ„Éó„ÅÆÂàùÊúüÊßãÁØâ
            
            requestAnimationFrame(gameLoop);
            els['giant-slime'].addEventListener('pointerdown', handleSlimeClick);
            saveInterval = setInterval(saveGame, 30000);
            setInterval(trySpawnGoldenSlime, 1000);
        }

        /* --- „Ç≤„Éº„É†„É≠„Ç∏„ÉÉ„ÇØ --- */

        function handleSlimeClick(e) {
            game.clicks++;
            const amount = calculateClickPower();
            addSlimes(amount);

            // „Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥ & „Ç®„Éï„Çß„ÇØ„Éà
            triggerSlimeAnim();
            const rect = els['giant-slime'].getBoundingClientRect();
            const clientX = e.clientX || (e.touches ? e.touches[0].clientX : rect.left + rect.width/2);
            const clientY = e.clientY || (e.touches ? e.touches[0].clientY : rect.top + rect.height/2);
            spawnFloatingText(`+${beautify(amount)}`, clientX, clientY);
            spawnParticles(clientX, clientY);
        }

        function addSlimes(amount) {
            game.slimes += amount;
            game.totalSlimes += amount;
            // UIÊõ¥Êñ∞„ÅØgameLoop„ÅßË°å„ÅÜ„Åå„ÄÅÂç≥ÊôÇÂèçÊò†„Åó„Åü„ÅÑÂ†¥Âêà„ÅØ„Åì„Åì„Åß„ÇÇÂëº„Å∂
        }

        // „ÇØ„É™„ÉÉ„ÇØÂäõË®àÁÆó
        function calculateClickPower() {
            let power = 1;
            
            // Âõ∫ÂÆöÂÄ§Âä†ÁÆó
            if (game.upgrades['glove1']) power += 1;
            if (game.upgrades['glove2']) power += 5;

            // SpSÂâ≤ÂêàÂä†ÁÆó
            if (game.upgrades['clickPercent1']) {
                power += calculateBaseSpS() * 0.01;
            }

            // ÂÄçÁéá
            if (game.upgrades['hardenedFinger']) power *= 2;
            
            // „Éê„Éï
            if (activeBuffs['clickFrenzy'] && activeBuffs['clickFrenzy'].endTime > Date.now()) {
                power *= activeBuffs['clickFrenzy'].multiplier;
            }

            return power;
        }

        // ÁîüÁî£ÈáèË®àÁÆó (SpS) - „Éê„ÉïËæº„Åø
        function calculateSpS() {
            let sps = calculateBaseSpS();
            
            // ÂÖ®‰ΩìÂÄçÁéá„Éê„Éï
            if (activeBuffs['frenzy'] && activeBuffs['frenzy'].endTime > Date.now()) {
                sps *= activeBuffs['frenzy'].multiplier;
            }

            return sps;
        }

        // Âü∫Á§éÁîüÁî£ÈáèË®àÁÆó (SpS)
        function calculateBaseSpS() {
            let sps = 0;
            BUILDINGS.forEach(b => {
                let count = game.buildings[b.id] || 0;
                let prod = b.baseProd * count;
                // ÂÄãÂà•„Ç¢„ÉÉ„Éó„Ç∞„É¨„Éº„Éâ
                if (b.id === 'ranch' && game.upgrades['blueDye']) prod *= 2;
                sps += prod;
            });
            // ÂÖ®‰Ωì„Ç¢„ÉÉ„Éó„Ç∞„É¨„Éº„Éâ
            if (game.upgrades['fakeStone']) sps *= 1.1;
            return sps;
        }

        // „Éê„ÉïËøΩÂä†
        function addBuff(type, durationSec, multiplier) {
            const now = Date.now();
            const endTime = now + durationSec * 1000;
            
            activeBuffs[type] = { endTime, multiplier };
            
            // Ë¶ñË¶öÂäπÊûú
            els['main-area'].classList.add('boost-active');
            setTimeout(updateBuffUI, 0);
        }

        /* --- „É°„Ç§„É≥„É´„Éº„Éó --- */
        function gameLoop(timestamp) {
            const dt = (timestamp - lastTick) / 1000;
            lastTick = timestamp;

            if (dt > 0) {
                const sps = calculateSpS();
                if (sps > 0) addSlimes(sps * dt);
            }

            checkUnlocks();
            updateBuffUI(); // „Éê„Éï„ÅÆÊÆã„ÇäÊôÇÈñìÊõ¥Êñ∞
            updateUI();
            
            requestAnimationFrame(gameLoop);
        }

        /* --- UIÊõ¥Êñ∞ --- */

        function updateUI() {
            els['score-display'].textContent = beautify(Math.floor(game.slimes));
            els['sps-display'].textContent = beautify(calculateSpS(), 1);
            
            updateShopButtons();
        }

        function updateBuffUI() {
            const now = Date.now();
            let hasActiveBuff = false;
            let html = '';

            for (const [type, buff] of Object.entries(activeBuffs)) {
                if (buff.endTime > now) {
                    hasActiveBuff = true;
                    const remaining = Math.ceil((buff.endTime - now) / 1000);
                    const label = type === 'frenzy' ? 'ÁîüÁî£3ÂÄç' : '„ÇØ„É™„ÉÉ„ÇØ5ÂÄç';
                    const color = type === 'frenzy' ? 'bg-red-500' : 'bg-blue-500';
                    html += `<div class="${color} text-white text-xs font-bold px-3 py-1 rounded-full shadow-lg animate-pulse">${label}: ${remaining}s</div>`;
                }
            }

            els['buff-container'].innerHTML = html;

            if (!hasActiveBuff) {
                els['main-area'].classList.remove('boost-active');
            }
        }

        function beautify(num, decimals = 0) {
            if (num < 1000) return num.toFixed(decimals);
            if (num < 1000000) return (num / 1000).toFixed(2) + 'k';
            if (num < 1000000000) return (num / 1000000).toFixed(3) + 'M';
            return (num / 1000000000).toFixed(3) + 'B';
        }

        /* --- „Ç∑„Éß„ÉÉ„ÉóÊèèÁîª --- */

        function getBuildingCost(id) {
            const b = BUILDINGS.find(x => x.id === id);
            return Math.floor(b.baseCost * Math.pow(1.15, game.buildings[id]));
        }

        function renderShop() {
            // Ê∂àËÄóÂìÅÊèèÁîª (ÂÜçË≥ºÂÖ•ÂèØËÉΩ„Å™„ÅÆ„ÅßÂ∏∏„Å´Ë°®Á§∫„Åó„Å¶„ÇÇ„ÅÑ„ÅÑ„Åå„ÄÅÊúÄÂàù„ÅØÈö†„Åô„Åã„ÇÇÔºü„Å®„Çä„ÅÇ„Åà„ÅöÂ∏∏ÊôÇË°®Á§∫)
            els['consumables-section'].classList.remove('hidden');
            els['consumables-container'].innerHTML = '';
            CONSUMABLES.forEach(item => {
                const div = document.createElement('div');
                div.id = `btn-consume-${item.id}`;
                div.className = "group bg-slate-700 hover:bg-slate-600 p-2 rounded border border-slate-600 cursor-pointer flex items-center justify-between transition-all active:scale-95";
                div.onclick = () => buyConsumable(item.id);
                div.innerHTML = `
                    <div class="flex items-center gap-3">
                        <div class="text-2xl">${item.icon}</div>
                        <div class="flex-1">
                            <div class="text-sm font-bold text-purple-200">${item.name}</div>
                            <div class="text-[10px] text-slate-300">${item.desc}</div>
                        </div>
                    </div>
                    <div class="text-right min-w-[60px]">
                        <div class="text-xs font-bold text-yellow-400" id="cost-consume-${item.id}">${beautify(item.baseCost)}</div>
                    </div>
                `;
                els['consumables-container'].appendChild(div);
            });

            // ÊñΩË®≠ÊèèÁîª
            els['buildings-container'].innerHTML = '';
            BUILDINGS.forEach(b => {
                const div = document.createElement('div');
                div.id = `btn-build-${b.id}`;
                div.className = "group relative bg-slate-700 hover:bg-slate-600 p-2 rounded cursor-pointer transition-colors select-none border border-slate-600 flex items-center justify-between active:scale-95";
                div.onclick = () => buyBuilding(b.id);

                div.innerHTML = `
                    <div class="flex items-center gap-3">
                        <div class="text-3xl">${b.icon}</div>
                        <div>
                            <div class="font-bold text-blue-100 text-sm">${b.name}</div>
                            <div class="text-[10px] text-slate-400 leading-tight max-w-[150px]">${b.desc}</div>
                        </div>
                    </div>
                    <div class="text-right">
                        <div class="text-xs font-bold text-green-400">Cost: <span id="cost-${b.id}">0</span></div>
                        <div class="text-xl font-bold text-slate-500" id="count-${b.id}">0</div>
                    </div>
                `;
                els['buildings-container'].appendChild(div);
            });
        }

        function updateShopButtons() {
            // ÊñΩË®≠
            BUILDINGS.forEach(b => {
                const cost = getBuildingCost(b.id);
                const btn = document.getElementById(`btn-build-${b.id}`);
                document.getElementById(`cost-${b.id}`).textContent = beautify(cost);
                document.getElementById(`count-${b.id}`).textContent = game.buildings[b.id];

                if (game.slimes >= cost) {
                    btn.classList.remove('opacity-50', 'grayscale');
                } else {
                    btn.classList.add('opacity-50', 'grayscale');
                }
            });

            // Ê∂àËÄóÂìÅ
            CONSUMABLES.forEach(item => {
                const btn = document.getElementById(`btn-consume-${item.id}`);
                // „Ç≥„Çπ„Éà„ÅØSpS„Å´Âøú„Åò„Å¶Â§âÂãï„Åï„Åõ„Çã„Å®„Éê„É©„É≥„Çπ„ÅåËâØ„ÅÑ„Åå„ÄÅ‰ªäÂõû„ÅØÂõ∫ÂÆö
                if (game.slimes >= item.baseCost) {
                    btn.classList.remove('opacity-50', 'grayscale');
                } else {
                    btn.classList.add('opacity-50', 'grayscale');
                }
            });

            // „Ç¢„ÉÉ„Éó„Ç∞„É¨„Éº„ÉâÔºàË≥ºÂÖ•ÂèØËÉΩ„Éª‰∏çÂèØ„ÅÆË¶ã„ÅüÁõÆÔºâ
            UPGRADES.forEach(u => {
                if (!game.upgrades[u.id]) {
                    const btn = document.getElementById(`btn-upgrade-${u.id}`);
                    if (btn) {
                        if (game.slimes >= u.cost) {
                            btn.classList.remove('opacity-50', 'grayscale');
                            btn.classList.add('hover:bg-blue-900');
                        } else {
                            btn.classList.add('opacity-50', 'grayscale');
                            btn.classList.remove('hover:bg-blue-900');
                        }
                    }
                }
            });
        }

        function buyBuilding(id) {
            const cost = getBuildingCost(id);
            if (game.slimes >= cost) {
                game.slimes -= cost;
                game.buildings[id]++;
                updateUI();
            }
        }

        function buyUpgrade(id) {
            const u = UPGRADES.find(x => x.id === id);
            if (game.slimes >= u.cost && !game.upgrades[id]) {
                game.slimes -= u.cost;
                game.upgrades[id] = true;
                
                // UI„Åã„ÇâÂâäÈô§
                const btn = document.getElementById(`btn-upgrade-${id}`);
                if(btn) btn.remove();
                
                // Á©∫„Å™„ÇâÈö†„Åô
                if (els['upgrades-container'].children.length === 0) {
                    els['upgrades-section'].classList.add('hidden');
                }
                updateUI();
            }
        }

        function buyConsumable(id) {
            const item = CONSUMABLES.find(x => x.id === id);
            // „Ç≥„Çπ„ÉàË®àÁÆóÔºà„Ç§„É≥„Éï„É¨„Åï„Åõ„Å¶„ÇÇ„ÅÑ„ÅÑ„Åå‰ªäÂõû„ÅØÂõ∫ÂÆöÔºâ
            const cost = item.baseCost; 
            
            if (game.slimes >= cost) {
                game.slimes -= cost;
                item.onBuy(game); // ÂäπÊûúÁô∫Âãï
                updateUI();
            }
        }

        function checkUnlocks() {
            let hasVisibleUpgrade = false;

            UPGRADES.forEach(u => {
                if (!game.upgrades[u.id] && u.condition(game)) {
                    if (!document.getElementById(`btn-upgrade-${u.id}`)) {
                        const div = document.createElement('div');
                        div.id = `btn-upgrade-${u.id}`;
                        div.className = "bg-slate-800 border border-blue-500 rounded p-2 cursor-pointer flex items-center gap-3 transition-all active:scale-95";
                        div.onclick = () => buyUpgrade(u.id);
                        div.innerHTML = `
                            <div class="text-2xl w-8 text-center">${u.icon}</div>
                            <div class="flex-1">
                                <div class="text-sm font-bold text-blue-300">${u.name}</div>
                                <div class="text-[10px] text-slate-300">${u.desc}</div>
                            </div>
                            <div class="text-xs font-bold text-yellow-400">${beautify(u.cost)}</div>
                        `;
                        els['upgrades-container'].appendChild(div);
                    }
                    hasVisibleUpgrade = true;
                } else if (!game.upgrades[u.id] && document.getElementById(`btn-upgrade-${u.id}`)) {
                    hasVisibleUpgrade = true;
                }
            });

            if (hasVisibleUpgrade) {
                els['upgrades-section'].classList.remove('hidden');
            } else {
                els['upgrades-section'].classList.add('hidden');
            }
        }

        /* --- ÊºîÂá∫„Éª„Åù„ÅÆ‰ªñ --- */

        function triggerSlimeAnim() {
            const s = els['giant-slime'];
            s.classList.remove('slime-click-anim');
            void s.offsetWidth;
            s.classList.add('slime-click-anim');
        }

        function spawnFloatingText(text, x, y) {
            const el = document.createElement('div');
            el.textContent = text;
            el.className = 'floating-number text-2xl md:text-4xl';
            el.style.left = `${x}px`;
            el.style.top = `${y}px`;
            el.style.transform = `translateX(${(Math.random() - 0.5) * 20}px)`;
            els['click-effect-container'].appendChild(el);
            setTimeout(() => el.remove(), 1000);
        }

        function spawnParticles(x, y) {
            for(let i=0; i<5; i++) {
                const p = document.createElement('div');
                p.className = 'particle bg-blue-300 w-2 h-2 md:w-3 md:h-3';
                p.style.left = `${x}px`;
                p.style.top = `${y}px`;
                const angle = Math.random() * Math.PI * 2;
                const dist = 50 + Math.random() * 50;
                p.style.setProperty('--tx', `${Math.cos(angle) * dist}px`);
                p.style.setProperty('--ty', `${Math.sin(angle) * dist}px`);
                els['click-effect-container'].appendChild(p);
                setTimeout(() => p.remove(), 800);
            }
        }

        function trySpawnGoldenSlime() {
            if (els['golden-slime-container'].children.length > 0) return;
            if (Math.random() < 0.01) spawnGoldenSlime();
        }

        function spawnGoldenSlime() {
            const gs = document.createElement('div');
            gs.className = 'golden-slime';
            const x = Math.random() * (window.innerWidth - 80) + 10;
            const y = Math.random() * (window.innerHeight - 80) + 10;
            gs.style.left = `${x}px`;
            gs.style.top = `${y}px`;
            gs.onclick = (e) => {
                e.stopPropagation();
                const sps = calculateSpS();
                const bonus = Math.max(sps * 600, 1000 + game.totalSlimes * 0.1);
                addSlimes(bonus);
                spawnFloatingText(`+${beautify(bonus)} (LUCKY!)`, x, y);
                gs.remove();
            };
            els['golden-slime-container'].appendChild(gs);
            setTimeout(() => { if(gs.parentNode) gs.remove(); }, 10000);
        }

        function saveGame() {
            game.lastSave = Date.now();
            localStorage.setItem('slimeClickerSave', JSON.stringify(game));
        }

        function loadGame() {
            const saved = localStorage.getItem('slimeClickerSave');
            if (saved) {
                try {
                    const parsed = JSON.parse(saved);
                    game = { ...game, ...parsed };
                    // „Éû„Éº„Ç∏Âá¶ÁêÜ
                    if(parsed.buildings) game.buildings = { ...game.buildings, ...parsed.buildings };
                    if(parsed.upgrades) game.upgrades = { ...game.upgrades, ...parsed.upgrades };
                } catch(e) { console.error(e); }
            }
        }

        function hardReset() {
            if(confirm("Êú¨ÂΩì„Å´„Éá„Éº„Çø„ÇíÊ∂àÂéª„Åó„Å¶„É™„Çª„ÉÉ„Éà„Åó„Åæ„Åô„ÅãÔºü")) {
                localStorage.removeItem('slimeClickerSave');
                location.reload();
            }
        }

        window.onload = init;
    </script>
</body>
</html>